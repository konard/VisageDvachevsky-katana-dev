name: Full CI (Main Branch)

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-and-test:
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        compiler:
          - { cc: gcc-13, cxx: g++-13 }
          - { cc: clang-18, cxx: clang++-18 }
        build_type: [Debug, Release]
        sanitizer: [none, asan, tsan, ubsan]
        exclude:
          - compiler: { cc: gcc-13, cxx: g++-13 }
            sanitizer: tsan

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Install LLVM repository (Ubuntu 22.04 only)
      if: matrix.os == 'ubuntu-22.04' && matrix.compiler.cc == 'clang-18'
      run: |
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main" | sudo tee /etc/apt/sources.list.d/llvm.list

    - name: Install dependencies
      run: |
        sudo apt-get update
        if [[ "${{ matrix.compiler.cc }}" == "gcc-13" ]]; then
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
        fi
        if [[ "${{ matrix.compiler.cc }}" == "clang-18" ]]; then
          sudo apt-get install -y cmake ninja-build ${{ matrix.compiler.cc }} ${{ matrix.compiler.cxx }} clang-tools-18 liburing-dev libc++-18-dev libc++abi-18-dev
        else
          sudo apt-get install -y cmake ninja-build ${{ matrix.compiler.cc }} ${{ matrix.compiler.cxx }} liburing-dev
        fi

    - name: Configure CMake
      run: |
        # Set sanitizer flags
        SANITIZER_FLAGS=""
        LINKER_FLAGS=""
        case "${{ matrix.sanitizer }}" in
          asan)
            SANITIZER_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g"
            LINKER_FLAGS="-fsanitize=address"
            ;;
          tsan)
            SANITIZER_FLAGS="-fsanitize=thread -fno-omit-frame-pointer -g"
            LINKER_FLAGS="-fsanitize=thread"
            ;;
          ubsan)
            SANITIZER_FLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g"
            LINKER_FLAGS="-fsanitize=undefined"
            ;;
        esac

        # Set clang scan-deps flags if using clang
        SCAN_DEPS_FLAGS=""
        if [[ "${{ matrix.compiler.cc }}" == "clang-18" ]]; then
          SCAN_DEPS_FLAGS="-DCMAKE_C_COMPILER_CLANG_SCAN_DEPS=/usr/bin/clang-scan-deps-18 -DCMAKE_CXX_COMPILER_CLANG_SCAN_DEPS=/usr/bin/clang-scan-deps-18"
        fi

        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_C_COMPILER=${{ matrix.compiler.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.compiler.cxx }} \
          -DCMAKE_CXX_FLAGS="$SANITIZER_FLAGS" \
          -DCMAKE_EXE_LINKER_FLAGS="$LINKER_FLAGS" \
          -DENABLE_TESTING=ON \
          ${SCAN_DEPS_FLAGS}

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{ matrix.build_type }} -j$(nproc)

    - name: Run Tests
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{ matrix.build_type }} --output-on-failure --verbose

  fuzzing:
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Install Clang
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-18 clang-tools-18 cmake ninja-build liburing-dev libc++-18-dev libc++abi-18-dev

    - name: Build Fuzzers
      run: |
        SCAN_DEPS_FLAGS="-DCMAKE_C_COMPILER_CLANG_SCAN_DEPS=/usr/bin/clang-scan-deps-18 -DCMAKE_CXX_COMPILER_CLANG_SCAN_DEPS=/usr/bin/clang-scan-deps-18"
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-18 \
          -DCMAKE_CXX_COMPILER=clang++-18 \
          -DENABLE_FUZZING=ON \
          ${SCAN_DEPS_FLAGS}
        cmake --build ${{github.workspace}}/build --target http_parser_fuzz

    - name: Run Fuzzers (short run)
      working-directory: ${{github.workspace}}/build/test/fuzz
      run: |
        ./http_parser_fuzz -max_total_time=60 -max_len=8192

  static-analysis:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy-18 cppcheck ninja-build

    - name: Configure (compile commands for analyzers)
      run: |
        cmake -B ${{github.workspace}}/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_TESTING=ON

    - name: Run clang-tidy
      run: |
        find katana/core/src katana/core/include -name '*.cpp' -o -name '*.hpp' | \
          xargs clang-tidy-18 -p build --warnings-as-errors=* || true

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --std=c++23 \
          --suppress=missingInclude \
          -I katana/core/include \
          katana/core/src examples

  lint:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install pre-commit
      run: pip install --no-cache-dir pre-commit

    - name: Run pre-commit
      run: pre-commit run --all-files
